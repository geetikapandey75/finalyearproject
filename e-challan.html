<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Challan Services</title>
  <script src="https://cdn.tailwindcss.com"></script>
   <!-- Leaflet CSS - MUST be loaded BEFORE Leaflet JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
</head>
<body class="bg-blue-50 font-sans text-gray-900">

  <!-- Navigation -->
  <header class="bg-blue-900 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">Legal Assist</h1>
      <nav class="space-x-4">
        <a href="police-complaint.html" class="hover:underline">Home</a>
        <a href="vehicle.html" class="hover:underline">Unclaimed Vehicles</a>
        <a href="passport.html" class="hover:underline">Passport Services</a>
        <a href="e-challan.html" class="hover:underline font-semibold text-yellow-300">E-Challan</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="text-center py-16 bg-gradient-to-r from-blue-800 to-blue-600 text-white">
    <h2 class="text-4xl font-bold mb-4">E-Challan Services</h2>
    <p class="mb-6 text-lg max-w-2xl mx-auto">
      Check, pay, or raise queries for your traffic challans online ‚Äî fast, simple, and secure.
    </p>
    <a href="#check" class="bg-yellow-400 text-black px-6 py-3 rounded-lg font-semibold hover:bg-yellow-300">Check Challan</a>
  </section>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-12 space-y-12">

    <!-- About -->
    <section class="bg-white rounded-xl shadow-lg p-8">
      <h3 class="text-2xl font-bold mb-4">About E-Challan</h3>
      <p class="text-gray-700 leading-relaxed">
        The E-Challan system is an initiative by the traffic police to ensure transparency and convenience in managing 
        traffic violations. It allows citizens to check and pay their pending challans online without visiting the RTO or police stations.
      </p>
    </section>

    <section id="check" class="bg-white rounded-xl shadow-lg p-8">
  <h3 class="text-2xl font-bold mb-6 text-center">Check Your Challan</h3>
  
<form method="POST" action="echallan.php" class="space-y-6 max-w-xl mx-auto">
    <div>
      <label class="block font-semibold mb-2">Vehicle Number</label>
      <input
        type="text"
        id="vehicleNo"
        name="vehicle_no"
        class="w-full p-4 border rounded-lg"
        placeholder="e.g., TS09AB1234"
        required
      >
    </div>

    <div>
      <label class="block font-semibold mb-2">Challan Number (if available)</label>
      <input
        type="text"
        id="challanNo"
        name="challan_no"
        class="w-full p-4 border rounded-lg"
        placeholder="Enter Challan Number (optional)"
      >
    </div>

    <button
      type="submit"
      class="bg-blue-700 text-white px-8 py-4 rounded-lg font-semibold hover:bg-blue-600 w-full"
    >
      Check Status
    </button>
  </form>
</section>

<script>
// JS to handle form submission without reloading page


  const vehicle = document.getElementById("vehicleNo").value.trim();
  const challan = document.getElementById("challanNo").value.trim();

  if (!vehicle && !challan) {
    alert("Enter Vehicle Number or Challan Number");
    return;
  }

  fetch(`api/api.php?action=check_challan&vehicle=${vehicle}&challan=${challan}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "not_found") {
        alert("No challan found for this vehicle/challan number.");
        return;
      }

      // Populate the result UI
      document.getElementById("resVehicle").textContent = data.vehicle_no;
      document.getElementById("resViolation").textContent = data.violation;
      document.getElementById("resDate").textContent = data.challan_date;
      document.getElementById("resAmount").textContent = data.amount;

      selectedChallanId = data.id; // save for payment
      document.getElementById("resultBox").classList.remove("hidden");
    })
    .catch(err => console.error(err));
;
</script>


    <!-- Payment Section -->
    <section class="bg-white rounded-xl shadow-lg p-8">
      <h3 class="text-2xl font-bold mb-4">How to Pay Your Challan</h3>
      <ol class="list-decimal list-inside space-y-2 text-gray-700">
        <li>Visit the official <a href="https://echallan.parivahan.gov.in/" target="_blank" class="text-blue-600 hover:underline">E-Challan Parivahan</a> website.</li>
        <li>Enter your vehicle number or challan ID.</li>
        <li>Review the violation details and total fine.</li>
        <li>Select your preferred online payment method (UPI / Debit Card / Net Banking).</li>
        <li>Download the payment receipt for future reference.</li>
      </ol>
    </section>

   
<script>
// JS to handle query form submission
document.getElementById("queryForm").addEventListener("submit", function(e) {
  e.preventDefault(); // prevent page reload

  const formData = new FormData(this);

  fetch("api/api.php?action=raise_query", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "submitted") {
      alert("Your query has been submitted successfully!");
      document.getElementById("queryForm").reset();
    } else if (data.error) {
      alert("Error: " + data.error);
    }
  })
  .catch(err => console.error(err));
});
</script>


<script>
  // Demo data (you can replace this with API later)
  const challanData = {
    "TS09AB1234": {
      violation: "Signal Jumping",
      amount: 1200,
      date: "2025-01-12"
    },
    "TS08ER9988": {
      violation: "No Helmet",
      amount: 500,
      date: "2025-01-05"
    }
  };

  const searchBtn = document.getElementById("searchBtn");
  const searchVehicle = document.getElementById("searchVehicle");

  const resultBox = document.getElementById("resultBox");
  const resVehicle = document.getElementById("resVehicle");
  const resViolation = document.getElementById("resViolation");
  const resDate = document.getElementById("resDate");
  const resAmount = document.getElementById("resAmount");

  const paymentModal = document.getElementById("paymentModal");
  const payBtn = document.getElementById("payBtn");
  const payAmount = document.getElementById("payAmount");
  const payAmountBtn = document.getElementById("payAmountBtn");
  const paymentMethod = document.getElementById("paymentMethod");
  const confirmPayment = document.getElementById("confirmPayment");
  const cancelPayment = document.getElementById("cancelPayment");

  const receiptBox = document.getElementById("receiptBox");
  const recVehicle = document.getElementById("recVehicle");
  const recAmount = document.getElementById("recAmount");
  const recMode = document.getElementById("recMode");
  const recDate = document.getElementById("recDate");

  let selectedVehicle = "";
  let selectedAmount = 0;

  // SEARCH CHALLAN
  searchBtn.addEventListener("click", () => {
    const vehicle = searchVehicle.value.trim().toUpperCase();

    if (vehicle === "") {
      alert("Enter a vehicle number");
      return;
    }

    if (challanData[vehicle]) {
      selectedVehicle = vehicle;
      selectedAmount = challanData[vehicle].amount;

      resVehicle.textContent = vehicle;
      resViolation.textContent = challanData[vehicle].violation;
      resDate.textContent = challanData[vehicle].date;
      resAmount.textContent = challanData[vehicle].amount;

      resultBox.classList.remove("hidden");
    } else {
      alert("No challan found for this vehicle.");
    }
  });

  // OPEN PAYMENT MODAL
  document.addEventListener("click", (e) => {
    if (e.target.id === "payBtn") {
      paymentModal.classList.remove("hidden");
      payAmount.textContent = selectedAmount;
      payAmountBtn.textContent = selectedAmount;
    }
  });

  // CANCEL PAYMENT
  cancelPayment.addEventListener("click", () => {
    paymentModal.classList.add("hidden");
  });

  // CONFIRM PAYMENT
  confirmPayment.addEventListener("click", () => {
    if (paymentMethod.value === "") {
      alert("Please select a payment method");
      return;
    }

    paymentModal.classList.add("hidden");

    recVehicle.textContent = selectedVehicle;
    recAmount.textContent = selectedAmount;
    recMode.textContent = paymentMethod.value;
    recDate.textContent = new Date().toLocaleString();

    receiptBox.classList.remove("hidden");
    window.scrollTo(0, receiptBox.offsetTop);
  });
</script>

<!-- Traffic Rules & Penalties Guide -->
<section class="mt-10 bg-white text-gray-800 rounded-2xl p-6 shadow-md border border-gray-200">

  <h2 class="text-2xl font-semibold text-center mb-1">
    üö¶ Traffic Rules & Penalties Guide
  </h2>
  <p class="text-center text-sm text-gray-500 mb-6">
    Know the rule ‚Ä¢ Avoid the fine ‚Ä¢ Stay safe
  </p>

  <!-- Search -->
  <input
    type="text"
    id="ruleSearch"
    placeholder="Search violation (helmet, signal, license...)"
    class="w-full mb-5 px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
    onkeyup="filterTrafficRules()"
  />

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border border-gray-300 rounded-lg overflow-hidden" id="rulesTable">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-4 py-3 text-left font-medium">Violation</th>
          <th class="px-4 py-3 text-left font-medium">Fine (‚Çπ)</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Riding without helmet</td>
          <td class="px-4 py-3">1000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Not wearing seat belt</td>
          <td class="px-4 py-3">1000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Signal jumping</td>
          <td class="px-4 py-3">1000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Over-speeding</td>
          <td class="px-4 py-3">1000 ‚Äì 2000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Using mobile while driving</td>
          <td class="px-4 py-3">1000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Driving without license</td>
          <td class="px-4 py-3">5000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Driving without insurance</td>
          <td class="px-4 py-3">2000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Wrong-side driving</td>
          <td class="px-4 py-3">1000</td>
        </tr>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">Drunk and drive</td>
          <td class="px-4 py-3">10000 + Jail</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Tip -->
  <div class="mt-6 flex items-start gap-3 bg-green-50 border-l-4 border-green-500 p-4 rounded-lg text-sm text-green-800">
    üí° Paying challans on time helps avoid legal trouble and extra penalties.
  </div>

  <!-- Rights -->
  <div class="mt-6 bg-gray-50 p-5 rounded-xl border border-gray-200">
    <h3 class="text-lg font-semibold text-orange-600 mb-3">
      ‚öñÔ∏è Know Your Rights
    </h3>
    <ul class="list-disc pl-5 space-y-2 text-sm text-gray-700">
      <li>Police cannot collect cash without an official receipt.</li>
      <li>You can verify challan details online anytime.</li>
      <li>You can dispute an incorrect challan with valid proof.</li>
    </ul>
  </div>

  

</section>


  <!-- Emergency Contacts -->
  <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mt-8">
    <h3 class="text-xl font-bold text-red-900 mb-4">üö® Emergency Contacts</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">100</p>
        <p class="text-sm text-gray-600">Police Emergency</p>
      </div>
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">102</p>
        <p class="text-sm text-gray-600">Ambulance</p>
      </div>
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">1073</p>
        <p class="text-sm text-gray-600">Traffic Helpline</p>
      </div>
    </div>
  </div>

</section>



<!-- ====================== POLICE STATION LOCATOR (FIXED) ====================== -->
<section class="container mx-auto px-6 py-12" id="policeStationSection">
  
  <!-- Header -->
  <div class="text-center mb-10">
    <h2 class="text-4xl font-bold text-blue-900 mb-3"> Find Nearest Police Station</h2>
    <p class="text-gray-600 text-lg">Locate police stations near you for emergency assistance</p>
  </div>

  <!-- Location Button -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <div>
          <p class="font-semibold text-gray-800">Your Location</p>
          <p class="text-sm text-gray-500" id="policeLocationText">Click button to detect</p>
        </div>
      </div>
      
      <button 
        id="policeFindBtn" 
        class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all transform hover:scale-105 shadow-md"
        onclick="findMyPoliceStations()"
      >
       Find Nearby Stations
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="policeLoadingState" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8">
    <div class="flex flex-col items-center justify-center">
      <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
      <p class="text-gray-700 font-semibold">Locating police stations near you...</p>
      <p class="text-gray-500 text-sm mt-2">This may take a few seconds</p>
    </div>
  </div>

  <!-- Map Container -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h3 class="text-2xl font-bold text-gray-800 mb-4"> Map View</h3>
    <div id="myPoliceMap" style="height: 500px; width: 100%; border-radius: 12px; border: 2px solid #e5e7eb;"></div>
  </div>

  <!-- Results Container -->
  <div id="policeResultsBox" class="hidden">
    <h3 class="text-2xl font-bold text-gray-800 mb-6"> Nearby Police Stations</h3>
    <div id="policeStationsListBox" class="grid md:grid-cols-2 gap-6"></div>
  </div>

  <!-- No Results Message -->
  <div id="noPoliceResultsBox" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
    <div class="flex items-center">
      <svg class="w-6 h-6 text-yellow-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <p class="font-semibold text-yellow-800">No police stations found nearby</p>
        <p class="text-sm text-yellow-700">Try again or check your location settings</p>
      </div>
    </div>
  </div>

  <!-- Emergency Contacts -->
  <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mt-8">
    <h3 class="text-xl font-bold text-red-900 mb-4">üö® Emergency Contacts</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">100</p>
        <p class="text-sm text-gray-600">Police Emergency</p>
      </div>
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">102</p>
        <p class="text-sm text-gray-600">Ambulance</p>
      </div>
      <div class="bg-white p-4 rounded-lg text-center hover:shadow-md transition">
        <p class="text-3xl font-bold text-red-600">1073</p>
        <p class="text-sm text-gray-600">Traffic Helpline</p>
      </div>
    </div>
  </div>

</section>

<!-- Police Locator Script - CLEAN VERSION -->
<script>
// Global variables for police station locator
var myPoliceMap = null;
var myUserMarker = null;
var myPoliceMarkers = [];
var myUserLat = null;
var myUserLng = null;

// Initialize map when page loads
window.addEventListener('load', function() {
  console.log('Initializing police map...');
  
  // Check if Leaflet is loaded
  if (typeof L === 'undefined') {
    console.error('Leaflet is not loaded!');
    alert('Map library not loaded. Please refresh the page.');
    return;
  }
  
  try {
    myPoliceMap = L.map('myPoliceMap').setView([20.5937, 78.9629], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(myPoliceMap);
    
    console.log('Police map initialized successfully');
  } catch(e) {
    console.error('Error initializing map:', e);
  }
});

// Custom marker icons
var blueIconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
var redIconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
var shadowUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png';

var blueMarkerIcon = L.icon({
  iconUrl: blueIconUrl,
  shadowUrl: shadowUrl,
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

var redMarkerIcon = L.icon({
  iconUrl: redIconUrl,
  shadowUrl: shadowUrl,
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// Main function to find police stations
function findMyPoliceStations() {
  console.log('Find button clicked!');
  
  var btn = document.getElementById('policeFindBtn');
  var loadingState = document.getElementById('policeLoadingState');
  var resultsBox = document.getElementById('policeResultsBox');
  var noResultsBox = document.getElementById('noPoliceResultsBox');
  var locationText = document.getElementById('policeLocationText');
  
  // Reset UI
  resultsBox.classList.add('hidden');
  noResultsBox.classList.add('hidden');
  loadingState.classList.remove('hidden');
  btn.disabled = true;
  btn.textContent = '‚è≥ Detecting Location...';
  
  // Clear previous markers
  myPoliceMarkers.forEach(function(marker) {
    myPoliceMap.removeLayer(marker);
  });
  myPoliceMarkers = [];
  
  if (myUserMarker) {
    myPoliceMap.removeLayer(myUserMarker);
  }
  
  // Get user location
  if (navigator.geolocation) {
    console.log('Requesting location...');
    
    navigator.geolocation.getCurrentPosition(
      function(position) {
        console.log('Location received:', position.coords);
        
        myUserLat = position.coords.latitude;
        myUserLng = position.coords.longitude;
        
        locationText.textContent = 'Location: ' + myUserLat.toFixed(4) + ', ' + myUserLng.toFixed(4);
        locationText.className = 'text-sm text-green-600 font-semibold';
        
        // Center map on user
        myPoliceMap.setView([myUserLat, myUserLng], 14);
        
        // Add user marker
        myUserMarker = L.marker([myUserLat, myUserLng], {icon: blueMarkerIcon})
          .addTo(myPoliceMap)
          .bindPopup('<b>Your Location</b>')
          .openPopup();
        
        // Search for police stations
        searchNearbyPoliceStations(myUserLat, myUserLng);
      },
      function(error) {
        console.error('Location error:', error);
        
        loadingState.classList.add('hidden');
        btn.disabled = false;
        btn.textContent = 'üìç Find Nearby Stations';
        
        var errorMsg = 'Unable to detect location';
        if (error.code === 1) {
          errorMsg = 'Location permission denied. Please enable location access.';
        } else if (error.code === 2) {
          errorMsg = 'Location unavailable. Please try again.';
        } else if (error.code === 3) {
          errorMsg = 'Location request timed out. Please try again.';
        }
        
        locationText.textContent = errorMsg;
        locationText.className = 'text-sm text-red-600';
        alert(errorMsg);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  } else {
    loadingState.classList.add('hidden');
    btn.disabled = false;
    btn.textContent = 'üìç Find Nearby Stations';
    alert('Geolocation is not supported by your browser');
  }
}

// Search using Overpass API
function searchNearbyPoliceStations(lat, lng) {
  console.log('Searching police stations near:', lat, lng);
  
  var radius = 5000; // 5km
  var overpassUrl = 'https://overpass-api.de/api/interpreter';
  
  var query = '[out:json][timeout:25];' +
    '(node["amenity"="police"](around:' + radius + ',' + lat + ',' + lng + ');' +
    'way["amenity"="police"](around:' + radius + ',' + lat + ',' + lng + ');' +
    'relation["amenity"="police"](around:' + radius + ',' + lat + ',' + lng + ');' +
    ');out center;';
  
  fetch(overpassUrl, {
    method: 'POST',
    body: 'data=' + encodeURIComponent(query),
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    }
  })
  .then(function(response) {
    return response.json();
  })
  .then(function(data) {
    console.log('Received police stations:', data.elements.length);
    displayPoliceStations(data.elements);
  })
  .catch(function(error) {
    console.error('Error fetching stations:', error);
    
    var loadingState = document.getElementById('policeLoadingState');
    var noResultsBox = document.getElementById('noPoliceResultsBox');
    var btn = document.getElementById('policeFindBtn');
    
    loadingState.classList.add('hidden');
    noResultsBox.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'üîÑ Try Again';
  });
}

// Display police stations
function displayPoliceStations(stations) {
  var loadingState = document.getElementById('policeLoadingState');
  var resultsBox = document.getElementById('policeResultsBox');
  var listBox = document.getElementById('policeStationsListBox');
  var noResultsBox = document.getElementById('noPoliceResultsBox');
  var btn = document.getElementById('policeFindBtn');
  
  loadingState.classList.add('hidden');
  btn.disabled = false;
  btn.textContent = 'üîÑ Refresh Results';
  
  if (stations.length === 0) {
    noResultsBox.classList.remove('hidden');
    return;
  }
  
  // Process stations
  var processed = [];
  stations.forEach(function(station) {
    var stationLat = station.lat || (station.center ? station.center.lat : null);
    var stationLng = station.lon || (station.center ? station.center.lon : null);
    
    if (stationLat && stationLng) {
      processed.push({
        name: station.tags.name || 'Police Station',
        lat: stationLat,
        lng: stationLng,
        address: station.tags['addr:full'] || station.tags['addr:street'] || 'Address not available',
        distance: getDistanceKm(myUserLat, myUserLng, stationLat, stationLng)
      });
    }
  });
  
  // Sort by distance
  processed.sort(function(a, b) {
    return a.distance - b.distance;
  });
  
  // Display
  resultsBox.classList.remove('hidden');
  listBox.innerHTML = '';
  
  processed.slice(0, 10).forEach(function(station, index) {
    addPoliceStationMarker(station, index + 1);
    createPoliceStationCard(station, index + 1);
  });
}

// Add marker
function addPoliceStationMarker(station, num) {
  var marker = L.marker([station.lat, station.lng], {icon: redMarkerIcon})
    .addTo(myPoliceMap)
    .bindPopup(
      '<div style="padding: 8px;">' +
      '<h3 style="font-weight: bold; margin-bottom: 4px;">' + num + '. ' + station.name + '</h3>' +
      '<p style="font-size: 12px; color: #666; margin-bottom: 4px;">' + station.address + '</p>' +
      '<p style="font-size: 12px; font-weight: 600; color: #2563eb;">üìç ' + station.distance.toFixed(2) + ' km away</p>' +
      '</div>'
    );
  
  myPoliceMarkers.push(marker);
}

// Create card
function createPoliceStationCard(station, num) {
  var listBox = document.getElementById('policeStationsListBox');
  
  var card = document.createElement('div');
  card.className = 'bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-xl transition-all cursor-pointer';
  
  card.innerHTML = 
    '<div class="flex items-start justify-between mb-3">' +
      '<div class="flex items-center gap-2">' +
        '<span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">' + num + '</span>' +
        '<h4 class="font-bold text-lg text-gray-800">' + station.name + '</h4>' +
      '</div>' +
    '</div>' +
    '<p class="text-gray-600 text-sm mb-3 flex items-start gap-2">' +
      '<svg class="w-4 h-4 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">' +
        '<path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>' +
      '</svg>' +
      '<span>' + station.address + '</span>' +
    '</p>' +
    '<div class="flex items-center justify-between text-sm">' +
      '<span class="text-blue-600 font-semibold">üìç ' + station.distance.toFixed(2) + ' km away</span>' +
      '<a href="https://www.google.com/maps/dir/?api=1&origin=' + myUserLat + ',' + myUserLng + '&destination=' + station.lat + ',' + station.lng + '" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-xs font-semibold">Get Directions</a>' +
    '</div>';
  
  card.addEventListener('click', function() {
    myPoliceMap.setView([station.lat, station.lng], 16);
    myPoliceMarkers[num - 1].openPopup();
  });
  
  listBox.appendChild(card);
}

// Calculate distance
function getDistanceKm(lat1, lon1, lat2, lon2) {
  var R = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

console.log('Police locator script loaded');
</script>


<!-- Safe Driving Mini Game -->
<section class="bg-white rounded-xl shadow-lg p-6 mt-10 max-w-md mx-auto">
  <h3 class="text-xl font-bold text-center mb-4">üöó Safe Driving Challenge</h3>

  <p id="sdQuestion" class="text-center font-semibold mb-4"></p>

  <div id="sdOptions" class="space-y-2"></div>

  <p class="text-center text-gray-600 mt-4">Score: 
      <span id="sdScore" class="font-bold text-blue-700">0</span>
  </p>
</section>

<!-- Score Popup -->
<div id="sdPopup"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded-xl max-w-sm w-full text-center shadow-lg">
    <h3 class="text-2xl font-bold mb-4">üèÜ Final Score</h3>
    <p id="sdFinalScore" class="text-xl font-semibold mb-4"></p>
    <button id="sdRestart" 
      class="bg-blue-700 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-600">
      Play Again
    </button>
  </div>
</div>











<!-- JS -->
<script>
// Questions
const sdQuestions = [
  {
    q: "You are feeling sleepy while driving. What should you do?",
    options: ["Drink water & continue", "Stop & rest", "Increase speed"],
    correct: 1
  },
  {
    q: "What is the safest following distance?",
    options: ["1 second", "3 seconds", "0.5 seconds"],
    correct: 1
  },
  {
    q: "You see a yellow signal. You should:",
    options: ["Accelerate", "Stop safely", "Ignore it"],
    correct: 1
  },
  {
    q: "Using mobile while driving is:",
    options: ["Okay at low speed", "Always dangerous", "Good for multitasking"],
    correct: 1
  },
  {
    q: "Seatbelts are:",
    options: ["Optional", "Only for highways", "Always required"],
    correct: 2
  }
];

let sdIndex = 0;
let sdScore = 0;

// DOM elements
const sdQuestion = document.getElementById("sdQuestion");
const sdOptions = document.getElementById("sdOptions");
const sdScoreDisplay = document.getElementById("sdScore");
const sdPopup = document.getElementById("sdPopup");
const sdFinalScore = document.getElementById("sdFinalScore");
const sdRestart = document.getElementById("sdRestart");

// Load Question
function loadSDQuestion() {
  const q = sdQuestions[sdIndex];
  sdQuestion.textContent = q.q;
  sdOptions.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.className = "w-full p-3 bg-gray-100 rounded-lg hover:bg-gray-200";
    btn.textContent = opt;

    btn.addEventListener("click", () => checkAnswer(i));
    sdOptions.appendChild(btn);
  });
}

// Check Answer
function checkAnswer(choice) {
  if (choice === sdQuestions[sdIndex].correct) {
    sdScore += 10;
  } else {
    sdScore -= 5;
  }

  sdScoreDisplay.textContent = sdScore;

  sdIndex++;

  if (sdIndex >= sdQuestions.length) {
    showFinalSDScore();
  } else {
    loadSDQuestion();
  }
}

// Final Score Popup
function showFinalSDScore() {
  sdFinalScore.textContent = `Your Score: ${sdScore}`;
  sdPopup.classList.remove("hidden");
}

// Restart
sdRestart.addEventListener("click", () => {
  sdIndex = 0;
  sdScore = 0;
  sdScoreDisplay.textContent = 0;
  sdPopup.classList.add("hidden");
  loadSDQuestion();
});

// Start Game
loadSDQuestion();
</script>
    <style>
  #whatsapp-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  }
  

  #whatsapp-button img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    cursor: pointer;
  }
</style>


</script>




<a href="https://wa.me/8897752518?text=Hello%20Legal%20Assist,%20I%20need%20help%20with%20your%20services" target="_blank" id="whatsapp-button">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="Chat with us on WhatsApp">
  <div class="footer">
  </main>
</body>
</html>